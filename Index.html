// åˆå§‹åŒ–è³‡æ–™å„²å­˜
let records = JSON.parse(localStorage.getItem('callRecords')) || [];

// æ—¥æœŸé¡¯ç¤º
document.getElementById('todayDate').textContent = 
    new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });

// å‹•æ…‹æ›´æ–°çµ±è¨ˆ
function updateStats() {
    document.getElementById('progress').textContent = records.length;
    const avg = records.reduce((sum, r) => sum + parseInt(r.intention), 0) / records.length || 0;
    document.getElementById('avgIntention').textContent = avg.toFixed(1);
}

// æ–°å¢è¨˜éŒ„åŠŸèƒ½
function addRecord() {
    const record = {
        type: document.getElementById('clientType').value,
        name: document.getElementById('clientName').value.trim(),
        phone: document.getElementById('clientPhone').value.trim(),
        propertyId: document.getElementById('propertyId').value.trim(),
        intention: document.getElementById('intentionLevel').value,
        followUp: new Date(Date.now() + 2 * 86400000).toISOString().split('T')[0],
        note: ''
    };

    if (!record.name || !record.phone || !record.propertyId) {
        alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼");
        return;
    }

    records.push(record);
    saveData();
    renderList();
}

// æ¸²æŸ“åˆ—è¡¨ï¼ˆå¡ç‰‡å¼è¨­è¨ˆï¼‰
function renderList() {
    const list = document.getElementById('recordsList');
    list.innerHTML = records.map((record, index) => `
        <div class="record-item">
            <div>
                <span class="badge ${record.type === 'buyer' ? 'buyer-badge' : 'seller-badge'}">
                    ${record.type === 'buyer' ? 'ğŸŸ¢ è²·æ–¹' : 'ğŸ”´ è³£æ–¹'}
                </span>
                <strong>${record.name}</strong>
            </div>
            <div>ğŸ“ ${record.phone.replace(/(\d{4})(\d{3})(\d{3})/, '09**-***-$3')}</div>
            <div>ğŸ  æˆ¿æºç·¨è™Ÿï¼š${record.propertyId}</div>
            <div>â­ æ„å‘ï¼š${'â˜…'.repeat(record.intention)}</div>
            <div>ğŸ“… ä¸‹æ¬¡è¯ç¹«ï¼š${record.followUp}</div>
            <div style="margin-top:12px;">
                <button onclick="deleteRecord(${index})" style="background:transparent;color:#FF3B30;border:1px solid #FF3B30;height:36px;">åˆªé™¤</button>
            </div>
        </div>
    `).join('');
}

// è³‡æ–™å„²å­˜å„ªåŒ–
function saveData() {
    localStorage.setItem('callRecords', JSON.stringify(records));
    updateStats();
}

// åˆªé™¤è¨˜éŒ„
function deleteRecord(index) {
    records.splice(index, 1);
    saveData();
    renderList();
}

// CSVåŒ¯å‡ºï¼ˆiOSé©é…ï¼‰
function exportCSV() {
    const csvContent = "data:text/csv;charset=utf-8," +
        "é¡å‹,å§“å,é›»è©±,æˆ¿æºç·¨è™Ÿ,æ„å‘ç­‰ç´š,ä¸‹æ¬¡è·Ÿé€²\n" +
        records.map(r => `${r.type},${r.name},${r.phone},${r.propertyId},${'â˜…'.repeat(r.intention)},${r.followUp}`).join("\n");

    const filename = `é›»è¨ªè¨˜éŒ„_${new Date().toISOString().slice(0,10)}.csv`;
    const link = document.createElement("a");
    link.href = encodeURI(csvContent);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
}

// è²“å’ªé ­éƒ¨æ–å‹•å‹•ç•«
function animateCatHead() {
    const catHead = document.querySelector('.cat-head');
    let angle = 0;
    setInterval(() => {
        angle = Math.sin(Date.now() / 300) * 5; // èª¿æ•´é€Ÿåº¦èˆ‡è§’åº¦å¹…åº¦
        catHead.style.transform = `translateX(-50%) rotate(${angle}deg)`;
    }, 50);
}

// åˆå§‹åŒ–åŸ·è¡Œ
renderList();
updateStats();
animateCatHead(); // å•Ÿå‹•è²“å’ªé ­éƒ¨å‹•ç•«
